<br>

D∆∞·ªõi ƒë√¢y l√† t√†i li·ªáu k·ªπ thu·∫≠t m√¥ t·∫£ c√°ch t√≠ch h·ª£p **OpenRouter** v√†o ·ª©ng d·ª•ng Spring Boot s·ª≠ d·ª•ng **Spring AI** th√¥ng qua endpoint REST.

---

# üìò T√†i li·ªáu T√≠ch H·ª£p OpenRouter v·ªõi Spring AI

## 1. M·ª•c ti√™u

Cung c·∫•p REST API ƒë·ªÉ g·ª≠i c√¢u h·ªèi v√† nh·∫≠n ph·∫£n h·ªìi t·ª´ m√¥ h√¨nh ng√¥n ng·ªØ th√¥ng qua **OpenRouter API**, s·ª≠ d·ª•ng th∆∞ vi·ªán `spring-ai`.

---

## 2. Ki·∫øn tr√∫c h·ªá th·ªëng

```
Client --> REST API (Spring Boot) --> Spring AI ChatClient --> OpenRouter API
```

---

## 3. C·∫•u h√¨nh h·ªá th·ªëng

### 3.1. Maven dependencies (`pom.xml`)

```xml
<properties>
    <java.version>17</java.version>
    <spring-ai.version>1.0.0-M6</spring-ai.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>${spring-ai.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

---

### 3.2. C·∫•u h√¨nh `application.yml`

```yaml
spring:
  application:
    name: deekseek-chat

  ai:
    openai:
      base-url: https://openrouter.ai/api
      api-key: MY_OPENAI_API_KEY   # Thay b·∫±ng API Key th·ª±c t·∫ø
      chat:
        options:
          model: deepseek/deepseek-r1:free
```

---

## 4. Tri·ªÉn khai

### 4.1. C·∫•u h√¨nh Bean `ChatClient`

```java
package com.news.be.deekseekchat;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ChatClientConfiguration {

    @Bean
    public ChatClient chatClient(ChatClient.Builder builder) {
        return builder.build();
    }
}
```

---

### 4.2. REST Controller

```java
package com.news.be.deekseekchat;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.UnknownContentTypeException;

import java.util.List;

@RestController
@RequestMapping("/api/v1/chat")
public class ChatController {

    private final ChatClient chatClient;

    public ChatController(ChatClient chatClient) {
        this.chatClient = chatClient;
    }

    @GetMapping
    public List<String> getAll() {
        return List.of("Hello", "World");
    }

    @PostMapping
    public ResponseEntity<?> ask(@RequestParam String question) {
        try {
            String response = this.chatClient.prompt()
                    .messages(new UserMessage(question))
                    .call()
                    .content();

            return ResponseEntity.ok(response);
        } catch (UnknownContentTypeException e) {
            return ResponseEntity.internalServerError()
                    .body("""
                        {
                            "error": "Invalid response format from OpenRouter",
                            "details": "Please check your API configuration"
                        }
                        """);
        }
    }

	@PostMapping("/read-file")
	public ResponseEntity<?> chat(@RequestParam("files") List<MultipartFile> files,  
                              @RequestParam String question) {  
    try {  
        List<Media> mediaList = files.stream()  
                .map(file -> new Media(  
                        MimeType.valueOf(file.getContentType()),  
                        file.getResource()  
                )).toList();  
        System.out.println("S·ªë t·ªáp nh·∫≠n ƒë∆∞·ª£c: " + files.size());  
        System.out.println("Danh s√°ch media: " + mediaList);  
  
        return ResponseEntity.ok(  
                this.chatClient  
                        .prompt()  
                        .messages(new UserMessage(question, mediaList))  
                        .call()  
                        .content()  
        );  
    } catch (UnknownContentTypeException e) {  
        e.printStackTrace();  
        return ResponseEntity.internalServerError().body(e.getMessage());  
    }  
}
}
```

---

## 5. Ki·ªÉm th·ª≠

### 5.1. S·ª≠ d·ª•ng CURL

```bash
curl --location 'http://localhost:8080/api/v1/chat' \
     --form 'question="So s√°nh iPhone 14 v√† iPhone 15"'
```

### 5.2. K·∫øt qu·∫£ mong ƒë·ª£i

```json
{
  "content": "iPhone 15 c√≥ c·∫£i ti·∫øn v·ªÅ camera, chip A17, v√† c·ªïng USB-C so v·ªõi iPhone 14."
}
```

---

## 6. Best Practices

- **B·∫£o m·∫≠t API Key**: Kh√¥ng hardcode trong source code, s·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng.
    
- **Retry logic**: C√¢n nh·∫Øc th√™m retry khi g·∫∑p l·ªói m·∫°ng ho·∫∑c response kh√¥ng h·ª£p l·ªá.
    
- **Logging**: Ghi log chi ti·∫øt ƒë·ªÉ debug ph·∫£n h·ªìi b·∫•t th∆∞·ªùng t·ª´ OpenRouter.
    
- **Validation**: Ki·ªÉm tra input ph√≠a client ƒë·ªÉ tr√°nh prompt injection.
    

---

## 7. K·∫øt lu·∫≠n

C·∫•u tr√∫c hi·ªán t·∫°i ƒë√£ s·∫µn s√†ng ƒë·ªÉ m·ªü r·ªông, h·ªó tr·ª£ c√°c m√¥ h√¨nh kh√°c tr√™n OpenRouter ho·∫∑c n√¢ng c·∫•p th√™m ch·ª©c nƒÉng nh∆∞ l∆∞u l·ªãch s·ª≠ h·ªôi tho·∫°i, ph√¢n t√≠ch logs, hay t√≠ch h·ª£p giao di·ªán ng∆∞·ªùi d√πng.

N·∫øu c·∫ßn tri·ªÉn khai c√°c ch·ª©c nƒÉng n√¢ng cao nh∆∞ **streaming**, **multi-turn conversation**, ho·∫∑c **fine-tuned prompts**, c·∫ßn c·∫≠p nh·∫≠t th√™m ph√≠a c·∫•u h√¨nh v√† logic x·ª≠ l√Ω.