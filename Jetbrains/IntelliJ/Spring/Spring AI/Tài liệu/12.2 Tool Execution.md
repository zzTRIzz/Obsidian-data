D∆∞·ªõi ƒë√¢y l√† h∆∞·ªõng d·∫´n chi ti·∫øt v·ªÅ **Tool Execution** trong Spring AI, bao g·ªìm lu·ªìng x·ª≠ l√Ω, c·∫•u h√¨nh v√† v√≠ d·ª• minh h·ªça:

---

### **1. Kh√°i Ni·ªám C·ªët L√µi**
**Tool Execution** l√† qu√° tr√¨nh th·ª±c thi c√°c c√¥ng c·ª• (tools) m√† AI Model y√™u c·∫ßu. Spring AI cung c·∫•p hai c√°ch ti·∫øp c·∫≠n:
- **Framework-Controlled**: Spring AI t·ª± ƒë·ªông x·ª≠ l√Ω (m·∫∑c ƒë·ªãnh).
- **User-Controlled**: Ng∆∞·ªùi d√πng t·ª± ki·ªÉm so√°t to√†n b·ªô lu·ªìng.

---

### **2. Framework-Controlled Tool Execution**
#### **2.1. Lu·ªìng X·ª≠ L√Ω T·ª± ƒê·ªông**
1. **G·ª≠i Prompt**: 
   ```java
   ChatResponse response = ChatClient.create(chatModel)
       .prompt("Ki·ªÉm tra th·ªùi ti·∫øt H√† N·ªôi")
       .tools(new WeatherTools())
       .call();
   ```
2. **Model Tr·∫£ V·ªÅ Tool Call**:
   - Model x√°c ƒë·ªãnh c·∫ßn g·ªçi tool `getWeather`.
   - Tr·∫£ v·ªÅ `ChatResponse` ch·ª©a t√™n tool v√† tham s·ªë.

3. **Spring AI T·ª± ƒê·ªông Th·ª±c Thi**:
   - `ToolCallingManager` nh·∫≠n di·ªán v√† g·ªçi tool.
   - K·∫øt qu·∫£ ƒë∆∞·ª£c g·ª≠i l·∫°i model ƒë·ªÉ x·ª≠ l√Ω ti·∫øp.

4. **Tr·∫£ K·∫øt Qu·∫£ Cu·ªëi C√πng**:
   ```java
   System.out.println(response.getContent()); // "Nhi·ªát ƒë·ªô H√† N·ªôi: 28¬∞C"
   ```

#### **2.2. C·∫•u H√¨nh M·∫∑c ƒê·ªãnh**
- **ToolCallingManager**: ƒê∆∞·ª£c t√≠ch h·ª£p s·∫µn (`DefaultToolCallingManager`).
- **Kh√¥ng C·∫ßn Code Th√™m**: Spring Boot t·ª± ƒë·ªông qu·∫£n l√Ω.

---

### **3. User-Controlled Tool Execution**
#### **3.1. K√≠ch Ho·∫°t Ch·∫ø ƒê·ªô Ki·ªÉm So√°t Th·ªß C√¥ng**
```java
// T·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông
ChatOptions options = ToolCallingChatOptions.builder()
    .internalToolExecutionEnabled(false)
    .toolCallbacks(new WeatherTools())
    .build();

// G·ªçi ChatModel
Prompt prompt = new Prompt("Ki·ªÉm tra th·ªùi ti·∫øt H√† N·ªôi", options);
ChatResponse response = chatModel.call(prompt);
```

#### **3.2. X·ª≠ L√Ω Tool Call Th·ªß C√¥ng**
```java
ToolCallingManager toolManager = ToolCallingManager.builder().build();

while (response.hasToolCalls()) {
    // Th·ª±c thi tool
    ToolExecutionResult result = toolManager.executeToolCalls(prompt, response);
    
    // C·∫≠p nh·∫≠t prompt v·ªõi l·ªãch s·ª≠ h·ªôi tho·∫°i
    prompt = new Prompt(result.conversationHistory(), options);
    
    // G·ªçi l·∫°i model
    response = chatModel.call(prompt);
}

System.out.println(response.getResult().getOutput().getText());
```

---

### **4. X·ª≠ L√Ω L·ªói (Exception Handling)**
#### **4.1. ToolExecutionException**
- **N√©m Exception Khi Tool Fail**:
  ```java
  @Tool(description = "L·∫•y th√¥ng tin s·∫£n ph·∫©m")
  public Product getProduct(String id) {
      if (id == null) {
          throw new ToolExecutionException("ID kh√¥ng h·ª£p l·ªá");
      }
      return productService.findById(id);
  }
  ```

#### **4.2. T√πy Ch·ªânh X·ª≠ L√Ω L·ªói**
- **T·∫°o Custom Processor**:
  ```java
  @Bean
  ToolExecutionExceptionProcessor errorProcessor() {
      return exception -> {
          // Ghi log v√† tr·∫£ message t√πy ch·ªânh
          log.error("L·ªói tool: {}", exception.getMessage());
          return "{\"error\": \"X·ª≠ l√Ω th·∫•t b·∫°i\"}";
      };
  }
  ```

- **C·∫•u H√¨nh Lu√¥n Throw Exception**:
  ```java
  @Bean
  ToolExecutionExceptionProcessor strictProcessor() {
      return new DefaultToolExecutionExceptionProcessor(true); // Lu√¥n throw exception
  }
  ```

---

### **5. Best Practices & V√≠ D·ª•**
#### **5.1. Khi N√†o D√πng User-Controlled?**
- **Debug Tool Calls**: Theo d√µi t·ª´ng b∆∞·ªõc th·ª±c thi.
- **T√≠ch H·ª£p Logic Ph·ª©c T·∫°p**: VD: Chu·ªói tool call c√≥ ƒëi·ªÅu ki·ªán.
- **X·ª≠ L√Ω L·ªói T√πy Ch·ªânh**: Can thi·ªáp s√¢u v√†o quy tr√¨nh l·ªói.

#### **5.2. V√≠ D·ª•: H·ªá Th·ªëng ƒê·∫∑t H√†ng**
```java
// ƒê·ªãnh nghƒ©a Tools
public class OrderTools {
    @Tool(description = "Ki·ªÉm tra t·ªìn kho")
    public boolean checkStock(String productId, int quantity) {
        return inventoryService.isAvailable(productId, quantity);
    }

    @Tool(description = "T·∫°o ƒë∆°n h√†ng")
    public String createOrder(OrderRequest request) {
        return orderService.placeOrder(request);
    }
}

// User-Controlled Execution
ChatOptions options = ToolCallingChatOptions.builder()
    .internalToolExecutionEnabled(false)
    .toolCallbacks(new OrderTools())
    .build();

Prompt prompt = new Prompt("ƒê·∫∑t 5 iPhone 15", options);
ChatResponse response = chatModel.call(prompt);

while (response.hasToolCalls()) {
    ToolExecutionResult result = toolManager.executeToolCalls(prompt, response);
    prompt = new Prompt(result.conversationHistory(), options);
    response = chatModel.call(prompt);
}

System.out.println("K·∫øt qu·∫£: " + response.getContent());
```

---

### **6. C·∫•u H√¨nh N√¢ng Cao**
#### **6.1. T√πy Ch·ªânh ToolCallingManager**
```java
@Bean
ToolCallingManager customToolManager() {
    return ToolCallingManager.builder()
        .toolExecutionEligibilityPredicate((options, response) -> {
            // Logic t√πy ch·ªânh ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ th·ª±c thi tool kh√¥ng
            return response != null && response.hasToolCalls();
        })
        .build();
}
```

#### **6.2. Ghi Log Tool Execution**
```java
@Aspect
@Component
public class ToolExecutionLogger {
    
    @Around("execution(* org.springframework.ai.tool.ToolCallingManager.executeToolCalls(..))")
    public Object logExecution(ProceedingJoinPoint jp) throws Throwable {
        Object[] args = jp.getArgs();
        Prompt prompt = (Prompt) args[0];
        ChatResponse response = (ChatResponse) args[1];
        
        log.info("Th·ª±c thi tool: {}", response.getToolCalls());
        Object result = jp.proceed();
        log.info("K·∫øt qu·∫£ tool: {}", result);
        
        return result;
    }
}
```

---

### **K·∫øt Lu·∫≠n**
- **Framework-Controlled**: ƒê∆°n gi·∫£n, ph√π h·ª£p cho h·∫ßu h·∫øt tr∆∞·ªùng h·ª£p.
- **User-Controlled**: Linh ho·∫°t, ki·ªÉm so√°t chi ti·∫øt lu·ªìng x·ª≠ l√Ω.
- **X·ª≠ L√Ω L·ªói**: T√πy ch·ªânh th√¥ng b√°o l·ªói ho·∫∑c logic ph·ª•c h·ªìi.
- **Lu√¥n Validate Input**: ƒê·∫£m b·∫£o d·ªØ li·ªáu ƒë·∫ßu v√†o h·ª£p l·ªá tr∆∞·ªõc khi th·ª±c thi tool.

√Åp d·ª•ng ƒë√∫ng c√°ch ti·∫øp c·∫≠n gi√∫p x√¢y d·ª±ng h·ªá th·ªëng AI m·∫°nh m·∫Ω v√† d·ªÖ b·∫£o tr√¨! üöÄ