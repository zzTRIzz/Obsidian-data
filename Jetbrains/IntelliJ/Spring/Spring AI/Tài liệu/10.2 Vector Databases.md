# T√†i li·ªáu h·ªçc t·∫≠p: Vector Databases trong Spring AI

## 1. Gi·ªõi thi·ªáu v·ªÅ Vector Databases
- **ƒê·ªãnh nghƒ©a**: C∆° s·ªü d·ªØ li·ªáu vector chuy√™n x·ª≠ l√Ω d·ªØ li·ªáu d·∫°ng vector, h·ªó tr·ª£ c√°c ·ª©ng d·ª•ng AI.
- **Kh√°c bi·ªát v·ªõi DB quan h·ªá**:
  - Kh√¥ng t√¨m ki·∫øm ch√≠nh x√°c m√† d·ª±a tr√™n **ƒë·ªô t∆∞∆°ng t·ª±** (similarity search).
  - Tr·∫£ v·ªÅ c√°c vector "gi·ªëng" nh·∫•t v·ªõi vector truy v·∫•n.
- **·ª®ng d·ª•ng ƒëi·ªÉn h√¨nh**: 
  - **Retrieval Augmented Generation (RAG)**: K·∫øt h·ª£p d·ªØ li·ªáu ng·ªØ c·∫£nh t·ª´ vector DB v·ªõi c√¢u h·ªèi ng∆∞·ªùi d√πng ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c c·ªßa AI.

---

## 2. API trong Spring AI
### 2.1. Interface `VectorStore`
```java
public interface VectorStore extends DocumentWriter {
    void add(List<Document> documents); // Th√™m d·ªØ li·ªáu
    void delete(...); // X√≥a theo ID ho·∫∑c bi·ªÉu th·ª©c l·ªçc
    List<Document> similaritySearch(String query); // T√¨m ki·∫øm t∆∞∆°ng t·ª±
    // ... C√°c ph∆∞∆°ng th·ª©c kh√°c
}
```

### 2.2. L·ªõp `SearchRequest`
- **M·ª•c ƒë√≠ch**: T√πy ch·ªânh t√¨m ki·∫øm v·ªõi c√°c tham s·ªë:
  - `query`: C√¢u truy v·∫•n.
  - `topK`: S·ªë l∆∞·ª£ng k·∫øt qu·∫£ t·ªëi ƒëa (m·∫∑c ƒë·ªãnh: 4).
  - `similarityThreshold`: Ng∆∞·ª°ng ƒë·ªô t∆∞∆°ng t·ª± (0.0-1.0).
  - `filterExpression`: L·ªçc metadata (v√≠ d·ª•: `country == 'UK' && year >= 2020`).

**V√≠ d·ª• t·∫°o SearchRequest**:
```java
SearchRequest request = SearchRequest.builder()
    .query("AI applications")
    .topK(5)
    .similarityThreshold(0.8)
    .filterExpression("category == 'technology'")
    .build();
```

---

## 3. C√°ch th·ª©c ho·∫°t ƒë·ªông
### 3.1. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh Vector
- **Embedding Model** (v√≠ d·ª•: OpenAI's text-embedding-ada-002) chuy·ªÉn vƒÉn b·∫£n th√†nh m·∫£ng s·ªë (`float[]`).
- **L∆∞u tr·ªØ**: Vector DB l∆∞u vector + metadata (t√™n file, tags...).

### 3.2. T√¨m ki·∫øm t∆∞∆°ng t·ª±
- S·ª≠ d·ª•ng thu·∫≠t to√°n nh∆∞ **Cosine Similarity** ho·∫∑c **Euclidean Distance** ƒë·ªÉ t√≠nh ƒë·ªô t∆∞∆°ng t·ª± gi·ªØa c√°c vector.

---

## 4. Schema Initialization
- **L∆∞u √Ω**: M·ªôt s·ªë vector DB y√™u c·∫ßu kh·ªüi t·∫°o schema tr∆∞·ªõc.
- **C·∫•u h√¨nh** (Spring Boot):
  ```properties
  spring.ai.vectorstore.[database-name].initialize-schema=true
  ```

---

## 5. Batching Strategy
### 5.1. T·∫°i sao c·∫ßn chia batch?
- Embedding Model c√≥ gi·ªõi h·∫°n token (v√≠ d·ª•: 8191 tokens v·ªõi OpenAI).
- Chia nh·ªè d·ªØ li·ªáu ƒë·ªÉ tr√°nh v∆∞·ª£t gi·ªõi h·∫°n, t·ªëi ∆∞u hi·ªáu su·∫•t.

### 5.2. `TokenCountBatchingStrategy`
- **C∆° ch·∫ø**:
  - T√≠nh to√°n token cho t·ª´ng document.
  - Nh√≥m th√†nh c√°c batch kh√¥ng v∆∞·ª£t qu√° `maxInputTokenCount * (1 - reservePercentage)`.
- **T√πy ch·ªânh**:
  ```java
  @Bean
  public BatchingStrategy customBatching() {
      return new TokenCountBatchingStrategy(
          EncodingType.CL100K_BASE, 
          8000, 
          0.1 // Reserve 10%
      );
  }
  ```

---

## 6. C√°c VectorStore Implementations
**Danh s√°ch h·ªó tr·ª£**:
- Azure Vector Search, Cassandra, Chroma, Elasticsearch...
- **SimpleVectorStore**: D√πng cho m·ª•c ƒë√≠ch h·ªçc t·∫≠p (l∆∞u tr·ªØ ƒë∆°n gi·∫£n).

**Th√™m implementation m·ªõi**:
- M·ªü issue/pull request tr√™n GitHub repo c·ªßa Spring AI.

---

## 7. V√≠ d·ª• s·ª≠ d·ª•ng
### 7.1. Load d·ªØ li·ªáu v√†o VectorStore
```java
@Autowired VectorStore vectorStore;

void loadData(String jsonFile) {
    JsonReader reader = new JsonReader(
        new FileSystemResource(jsonFile),
        "price", "name", "description" // Tr√≠ch xu·∫•t c√°c tr∆∞·ªùng
    );
    List<Document> docs = reader.get();
    vectorStore.add(docs);
}
```

### 7.2. T√¨m ki·∫øm v√† s·ª≠ d·ª•ng v·ªõi RAG
```java
String question = "·ª®ng d·ª•ng c·ªßa AI trong y t·∫ø?";
List<Document> contextDocs = vectorStore.similaritySearch(
    SearchRequest.builder()
        .query(question)
        .topK(3)
        .similarityThreshold(0.75)
        .build()
);

// K·∫øt h·ª£p contextDocs + question g·ª≠i ƒë·∫øn AI model
```

---

## 8. Best Practices
- **Ch·ªçn Embedding Model ph√π h·ª£p** v·ªõi AI model (v√≠ d·ª•: d√πng `text-embedding-ada-002` cho ChatGPT).
- **L·ªçc metadata hi·ªáu qu·∫£** ƒë·ªÉ gi·∫£m nhi·ªÖu trong k·∫øt qu·∫£.
- **Theo d√µi hi·ªáu su·∫•t**: ƒêi·ªÅu ch·ªânh `topK` v√† `similarityThreshold` ƒë·ªÉ c√¢n b·∫±ng ƒë·ªô ch√≠nh x√°c v√† t·ªëc ƒë·ªô.

---

## 9. T√†i nguy√™n tham kh·∫£o
- [Spring AI Documentation](https://spring.io/projects/spring-ai)
- [Vector Similarity Explained](https://towardsdatascience.com/vector-similarity-101-8d90e3f2960f)
- [RAG Pattern](https://arxiv.org/abs/2005.11401)

**Ch√∫c b·∫°n h·ªçc t·∫≠p hi·ªáu qu·∫£!** üöÄ

---

# T√†i li·ªáu h·ªçc t·∫≠p: Metadata Filters trong Vector Databases

## 1. Gi·ªõi thi·ªáu Metadata Filters
**Metadata Filters** cho ph√©p l·ªçc k·∫øt qu·∫£ t√¨m ki·∫øm d·ª±a tr√™n c√°c thu·ªôc t√≠nh metadata c·ªßa Document.  
H·ªó tr·ª£ 2 c√°ch tri·ªÉn khai:
- **Filter String**: Bi·ªÉu th·ª©c SQL-like d·∫°ng chu·ªói.
- **Filter.Expression**: X√¢y d·ª±ng bi·ªÉu th·ª©c l·ªçc qua fluent API.

---

## 2. S·ª≠ d·ª•ng Filter String
### 2.1. C√∫ ph√°p
- T∆∞∆°ng t·ª± SQL, √°p d·ª•ng tr√™n c√°c key trong metadata.
- V√≠ d·ª•:
  ```java
  // L·ªçc theo country
  "country == 'BG'"
  
  // K·∫øt h·ª£p nhi·ªÅu ƒëi·ªÅu ki·ªán
  "genre == 'drama' && year >= 2020"
  
  // S·ª≠ d·ª•ng to√°n t·ª≠ IN
  "genre in ['comedy', 'documentary', 'drama']"
  ```

### 2.2. V√≠ d·ª• s·ª≠ d·ª•ng
```java
SearchRequest request = SearchRequest.builder()
    .query("AI applications")
    .filterExpression("category == 'technology' && year >= 2023")
    .build();
List<Document> results = vectorStore.similaritySearch(request);
```

---

## 3. S·ª≠ d·ª•ng Filter.Expression Builder
### 3.1. Fluent API
- X√¢y d·ª±ng bi·ªÉu th·ª©c ph·ª©c t·∫°p v·ªõi c√°c to√°n t·ª≠ logic.
- **V√≠ d·ª• c∆° b·∫£n**:
  ```java
  FilterExpressionBuilder b = new FilterExpressionBuilder();
  Expression exp = b.eq("country", "BG").build(); // country == 'BG'
  ```

### 3.2. To√°n t·ª≠ h·ªó tr·ª£
| To√°n t·ª≠          | √ù nghƒ©a                  |
|-------------------|--------------------------|
| `eq()`, `ne()`    | B·∫±ng/Kh√°c                |
| `gt()`, `gte()`   | L·ªõn h∆°n/L·ªõn h∆°n ho·∫∑c b·∫±ng|
| `lt()`, `lte()`   | Nh·ªè h∆°n/Nh·ªè h∆°n ho·∫∑c b·∫±ng|
| `in()`, `nin()`   | Trong/Kh√¥ng trong danh s√°ch|
| `and()`, `or()`   | Logic AND/OR             |
| `not()`           | Ph·ªß ƒë·ªãnh                 |

### 3.3. V√≠ d·ª• ph·ª©c t·∫°p
```java
// genre l√† 'drama' HO·∫∂C nƒÉm >= 2020
Expression exp = b.or(
    b.eq("genre", "drama"),
    b.gte("year", 2020)
).build();

// genre in ['comedy', 'drama'] V√Ä nƒÉm != 2021
Expression exp = b.and(
    b.in("genre", "comedy", "drama"),
    b.ne("year", 2021)
).build();
```

---

## 4. X√≥a Document kh·ªèi Vector Store
### 4.1. X√≥a theo ID
```java
// X√≥a document c√≥ ID c·ª• th·ªÉ
vectorStore.delete(List.of("doc_id_1", "doc_id_2"));
```

### 4.2. X√≥a b·∫±ng Filter Expression
```java
// X√≥a t·∫•t c·∫£ document c√≥ country = 'Bulgaria'
Filter.Expression exp = b.eq("country", "Bulgaria").build();
vectorStore.delete(exp);

// Ho·∫∑c d√πng string filter
vectorStore.delete("country == 'Netherlands'");
```

### 4.3. V√≠ d·ª• th·ª±c t·∫ø
```java
// Th√™m documents
Document doc1 = new Document("Doc1", Map.of("country", "VN", "version", "1.0"));
Document doc2 = new Document("Doc2", Map.of("country", "US", "version", "2.0"));
vectorStore.add(List.of(doc1, doc2));

// X√≥a c√°c b·∫£n c≈© c·ªßa VN
vectorStore.delete("country == 'VN' && version < '2.0'");
```

---

## 5. X·ª≠ l√Ω l·ªói khi X√≥a
- Lu√¥n b·ªçc l·ªánh x√≥a trong `try-catch` ƒë·ªÉ x·ª≠ l√Ω ngo·∫°i l·ªá:
```java
try {
    vectorStore.delete("invalid_field == 'value'");
} catch (FilterExpressionException e) {
    System.err.println("L·ªói bi·ªÉu th·ª©c l·ªçc: " + e.getMessage());
}
```

---

## 6. Use Case: Qu·∫£n l√Ω Version Document
### 6.1. B√†i to√°n
- Khi c·∫≠p nh·∫≠t document m·ªõi, x√≥a c√°c version c≈© c√πng `docId`.

### 6.2. Tri·ªÉn khai
```java
// T·∫°o document version 1.0
Document v1 = new Document("Content", Map.of("docId", "DOC-001", "version", "1.0"));
vectorStore.add(List.of(v1));

// Khi c·∫≠p nh·∫≠t version 2.0
Document v2 = new Document("New Content", Map.of("docId", "DOC-001", "version", "2.0"));

// X√≥a version c≈©
vectorStore.delete("docId == 'DOC-001' && version == '1.0'");

// Th√™m version m·ªõi
vectorStore.add(List.of(v2));
```

---

## 7. L∆∞u √Ω Hi·ªáu su·∫•t
- **X√≥a theo ID**: Nhanh nh·∫•t, d√πng khi bi·∫øt ch√≠nh x√°c ID c·∫ßn x√≥a.
- **X√≥a b·∫±ng Filter**: 
  - C√≥ th·ªÉ ch·∫≠m h∆°n do qu√©t index.
  - T·ªëi ∆∞u b·∫±ng c√°ch k·∫øt h·ª£p c√°c ƒëi·ªÅu ki·ªán l·ªçc ch·∫∑t ch·∫Ω.
- **Batch Operations**: Chia nh·ªè thao t√°c x√≥a l·ªõn th√†nh c√°c l√¥ nh·ªè ƒë·ªÉ tr√°nh qu√° t·∫£i.

---

## 8. Best Practices
1. **S·ª≠ d·ª•ng Filter String** cho bi·ªÉu th·ª©c ƒë∆°n gi·∫£n.
2. **D√πng Filter.Expression Builder** cho logic ph·ª©c t·∫°p.
3. **Ki·ªÉm tra Metadata**: ƒê·∫£m b·∫£o c√°c key d√πng trong filter t·ªìn t·∫°i.
4. **Logging**: Ghi log c√°c thao t√°c x√≥a ƒë·ªÉ debug sau n√†y.

**V√≠ d·ª• k·∫øt h·ª£p**:
```java
SearchRequest request = SearchRequest.builder()
    .query("Machine Learning")
    .topK(10)
    .filterExpression(
        b.and(
            b.in("category", "AI", "Data Science"),
            b.gte("year", 2022)
        ).build()
    )
    .build();
```

---

**Ch√∫c b·∫°n √°p d·ª•ng Metadata Filters hi·ªáu qu·∫£!** üéØ